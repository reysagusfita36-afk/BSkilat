<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Lembar Gambar - PDAM Tirta Langkisau</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --accent-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        body {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            font-family: 'Segoe UI', sans-serif;
            color: var(--dark-color);
            transition: var(--transition);
        }
        body.dark-mode {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #ecf0f1;
        }
        body.dark-mode .card,
        body.dark-mode .page-container {
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #34495e;
            color: #ecf0f1;
            border-color: #4a5f7f;
        }
        body.dark-mode .image-preview-item {
            background-color: #34495e;
            border-color: #4a5f7f;
        }
        .app-header {
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 25px 0;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }
        .app-header h1 {
            font-weight: 700;
            margin-bottom: 5px;
        }
        .app-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            margin-bottom: 25px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .card-header {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        .card-body {
            padding: 25px;
        }
        .btn {
            border-radius: 25px;
            padding: 10px 20px;
            font-weight: 600;
            transition: var(--transition);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .image-container {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        .image-item {
            position: relative;
            border: 2px solid #e1e5ee;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            background-color: white;
            transition: var(--transition);
        }
        .image-item:hover {
            border-color: var(--accent-color);
            transform: scale(1.02);
        }
        .image-item img {
            max-width: 100%;
            max-height: 100%;
            display: block;
            border-radius: 6px;
        }
        .image-counter {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .drop-zone {
            border: 3px dashed #c1c8e4;
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: var(--transition);
            background-color: #f8f9ff;
        }
        .drop-zone:hover,
        .drop-zone.active {
            border-color: var(--primary-color);
            background-color: #eef2ff;
        }
        .drop-zone i {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .image-preview-item {
            position: relative;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background: white;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-preview-item .btn-remove-preview {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: var(--transition);
        }
        .image-preview-item .btn-remove-preview:hover {
            background: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }
        .image-preview-item .preview-number {
            position: absolute;
            bottom: 4px;
            left: 4px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
        }
        .page-container {
            border: 2px solid #e1e5ee;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            padding: 20px;
            page-break-inside: avoid;
            background-color: white;
            box-shadow: var(--box-shadow);
        }
        .page-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 15px;
        }
        .page-header h3 {
            color: var(--primary-color);
            font-weight: 700;
            margin-bottom: 15px;
        }
        .page-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-color);
        }
        .page-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .page-info-row:last-child {
            margin-bottom: 0;
        }
        .page-info-label {
            font-weight: 600;
            color: #495057;
        }
        .page-info-value {
            color: #212529;
        }
        .stats-card {
            text-align: center;
            padding: 20px;
        }
        .stats-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .stats-card .label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }
        .sheet-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: var(--transition);
        }
        .sheet-item:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
            cursor: pointer;
        }
        .sheet-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .sheet-item-title {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        .sheet-item-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .sheet-item-actions {
            margin-top: 10px;
        }
        .page-indicator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .page-container {
                border: 1px solid #000;
                page-break-after: always;
                box-shadow: none;
                margin: 0;
                padding: 15mm;
            }
            .image-counter {
                display: block !important;
            }
            body {
                background: white;
            }
            @page {
                size: A4;
                margin: 0;
            }
        }
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            .image-preview-container {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="container">
            <h1><i class="fas fa-images me-2"></i>Manajemen Lembar Gambar</h1>
            <p>PDAM Tirta Langkisau - Kelola dan atur gambar bukti setoran harian dengan mudah</p>
        </div>
    </div>

    <div class="container">
        <!-- Toggle Mode Gelap -->
        <div class="d-flex justify-content-end mb-3 no-print">
            <button id="darkModeToggle" class="btn btn-outline-secondary">
                <i class="fas fa-moon"></i> Mode Gelap
            </button>
        </div>

        <!-- Form untuk membuat lembar baru -->
        <div class="card mb-4 no-print">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Buat Lembar Baru</h5>
            </div>
            <div class="card-body">
                <form id="sheetForm">
                    <!-- Informasi Umum -->
                    <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Informasi Umum</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="pageTitle" class="form-label">Judul Halaman *</label>
                            <input type="text" class="form-control" id="pageTitle" placeholder="Contoh: REKAPITULASI PENERIMAAN HARIAN" required>
                        </div>
                        <div class="col-md-6">
                            <label for="pageDate" class="form-label">Hari/Tanggal *</label>
                            <input type="date" class="form-control" id="pageDate" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="responsible" class="form-label">Penanggung Jawab *</label>
                            <input type="text" class="form-control" id="responsible" placeholder="Nama penanggung jawab" required>
                        </div>
                        <div class="col-md-6">
                            <label for="department" class="form-label">Departemen/Bagian</label>
                            <input type="text" class="form-control" id="department" placeholder="Contoh: Keuangan, Administrasi">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="location" class="form-label">Lokasi</label>
                            <input type="text" class="form-control" id="location" placeholder="Contoh: Kantor Pusat">
                        </div>
                        <div class="col-md-6">
                            <label for="category" class="form-label">Kategori</label>
                            <select class="form-select" id="category">
                                <option value="">-- Pilih Kategori --</option>
                                <option value="Setoran Harian">Setoran Harian</option>
                                <option value="Pembayaran Pelanggan">Pembayaran Pelanggan</option>
                                <option value="Penerimaan Kas">Penerimaan Kas</option>
                                <option value="Bukti Transfer">Bukti Transfer</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <label for="notes" class="form-label">Keterangan Tambahan</label>
                            <textarea class="form-control" id="notes" rows="3" placeholder="Catatan atau keterangan tambahan..."></textarea>
                        </div>
                    </div>

                    <hr>

                    <!-- Konfigurasi Layout -->
                    <h6 class="text-primary mb-3"><i class="fas fa-th me-2"></i>Konfigurasi Layout Per Halaman</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="columnsCount" class="form-label">Jumlah Gambar ke Samping</label>
                            <select class="form-select" id="columnsCount" required>
                                <option value="1">1 Kolom</option>
                                <option value="2">2 Kolom</option>
                                <option value="3">3 Kolom</option>
                                <option value="4" selected>4 Kolom</option>
                                <option value="5">5 Kolom</option>
                                <option value="6">6 Kolom</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="rowsCount" class="form-label">Jumlah Gambar ke Bawah</label>
                            <select class="form-select" id="rowsCount" required>
                                <option value="1">1 Baris</option>
                                <option value="2">2 Baris</option>
                                <option value="3" selected>3 Baris</option>
                                <option value="4">4 Baris</option>
                                <option value="5">5 Baris</option>
                                <option value="6">6 Baris</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>Konfigurasi:</strong>
                                    <span id="configInfo">4 gambar ke samping Ã— 3 gambar ke bawah = 12 gambar per halaman</span>
                                    <br>
                                    <small class="text-muted">Gambar akan otomatis dibagi ke halaman-halaman sesuai kapasitas yang dipilih</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- Upload Gambar -->
                    <h6 class="text-primary mb-3"><i class="fas fa-cloud-upload-alt me-2"></i>Upload Gambar</h6>
                    <div class="mb-3">
                        <div class="drop-zone" id="dropZone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p class="mb-2">Drag & drop gambar di sini atau klik untuk memilih</p>
                            <p class="text-muted mb-0" style="font-size: 0.9rem;">Upload sebanyak yang Anda mau, sistem akan otomatis membagi ke halaman-halaman</p>
                            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                        </div>
                        <div class="form-text">Format yang didukung: JPG, PNG, GIF (Max 5MB per gambar)</div>
                    </div>

                    <!-- Preview gambar yang diupload -->
                    <div id="imagePreviewSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="text-primary mb-0">
                                <i class="fas fa-images me-2"></i>Gambar yang Diupload (<span id="uploadedCount">0</span>)
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="clearImagesBtn">
                                <i class="fas fa-trash me-1"></i>Hapus Semua
                            </button>
                        </div>
                        <div id="imagePreviewContainer" class="image-preview-container">
                            <!-- Preview gambar akan muncul di sini -->
                        </div>
                        <div class="alert alert-success mt-3">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="pagesEstimate">Dengan setting saat ini, gambar akan dibagi menjadi <strong>1 halaman</strong></span>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                            <i class="fas fa-redo me-2"></i>Reset Form
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Simpan Lembar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Statistik -->
        <div class="row mb-4 no-print">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="number" id="totalSheets">0</div>
                    <div class="label">Total Lembar</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="number" id="totalImages">0</div>
                    <div class="label">Total Gambar</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="number" id="totalPages">0</div>
                    <div class="label">Total Halaman</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="number" id="storageUsage">0%</div>
                    <div class="label">Penggunaan Storage</div>
                </div>
            </div>
        </div>

        <!-- Storage Warning -->
        <div id="storageWarning" class="alert alert-warning alert-dismissible fade show no-print" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Peringatan Storage!</strong> 
            <span id="storageWarningText"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Daftar lembar yang tersimpan -->
        <div class="card no-print">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-folder me-2"></i>Lembar Tersimpan</h5>
                <span class="badge bg-primary rounded-pill" id="sheetsCount">0</span>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Cari berdasarkan judul, tanggal, atau penanggung jawab...">
                    </div>
                </div>
                <div id="savedSheetsList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Belum ada lembar tersimpan. Buat lembar baru untuk memulai.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Area preview untuk print/PDF -->
        <div id="previewArea" class="mt-4">
            <!-- Halaman akan ditampilkan di sini -->
        </div>

        <!-- Tombol aksi -->
        <div class="action-buttons no-print" id="actionButtons" style="display: none;">
            <button id="printBtn" class="btn btn-success">
                <i class="fas fa-print me-2"></i>Print / Export PDF
            </button>
            <button id="exportZipBtn" class="btn btn-info">
                <i class="fas fa-download me-2"></i>Export Semua ZIP
            </button>
            <button id="clearAllBtn" class="btn btn-danger">
                <i class="fas fa-trash me-2"></i>Hapus Semua
            </button>
        </div>

        <!-- Modal Konfirmasi Export -->
        <div class="modal fade" id="exportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Export Berhasil!</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <i class="fas fa-file-archive fa-3x text-success mb-3"></i>
                        <p class="mb-3">File ZIP berhasil diunduh!</p>
                        <p class="text-muted">Apakah Anda ingin menghapus lembar yang sudah diexport untuk mengosongkan storage?</p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Menghapus lembar akan membebaskan ruang di browser Anda</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Tidak, Simpan
                        </button>
                        <button type="button" class="btn btn-danger" id="confirmClearAfterExport">
                            <i class="fas fa-trash me-2"></i>Ya, Hapus Semua
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let sheets = [];
        let currentImages = [];
        let exportModal;

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            loadSheets();
            updateStats();
            setupEventListeners();
            setDefaultDate();
            checkStorageUsage();
            exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
        });

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('pageDate').value = today;
        }

        function setupEventListeners() {
            // Dark mode toggle
            document.getElementById('darkModeToggle').addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                const icon = this.querySelector('i');
                if (document.body.classList.contains('dark-mode')) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                    this.innerHTML = '<i class="fas fa-sun"></i> Mode Terang';
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                    this.innerHTML = '<i class="fas fa-moon"></i> Mode Gelap';
                }
            });

            // Update config info
            document.getElementById('columnsCount').addEventListener('change', () => {
                updateConfigInfo();
                updatePagesEstimate();
            });
            document.getElementById('rowsCount').addEventListener('change', () => {
                updateConfigInfo();
                updatePagesEstimate();
            });

            // Drop zone
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('active');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });

            // Clear images button
            document.getElementById('clearImagesBtn').addEventListener('click', () => {
                if (confirm('Yakin ingin menghapus semua gambar yang diupload?')) {
                    currentImages = [];
                    renderImagePreview();
                    showToast('Semua gambar dihapus', 'info');
                }
            });

            // Form submit
            document.getElementById('sheetForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSheet();
            });

            // Reset button
            document.getElementById('resetBtn').addEventListener('click', resetForm);

            // Search
            document.getElementById('searchInput').addEventListener('input', function(e) {
                filterSheets(e.target.value);
            });

            // Action buttons
            document.getElementById('printBtn').addEventListener('click', printPages);
            document.getElementById('exportZipBtn').addEventListener('click', exportZip);
            document.getElementById('clearAllBtn').addEventListener('click', clearAll);
            
            // Modal confirm
            document.getElementById('confirmClearAfterExport').addEventListener('click', function() {
                clearAll(true);
                exportModal.hide();
            });
        }

        function checkStorageUsage() {
            try {
                const data = JSON.stringify(sheets);
                const usedBytes = new Blob([data]).size;
                const maxBytes = 5 * 1024 * 1024; // 5MB estimate
                const percentage = Math.round((usedBytes / maxBytes) * 100);
                
                const storageElement = document.getElementById('storageUsage');
                const warningElement = document.getElementById('storageWarning');
                const warningText = document.getElementById('storageWarningText');
                
                storageElement.textContent = percentage + '%';
                
                // Color coding
                if (percentage < 50) {
                    storageElement.className = 'number text-success';
                    warningElement.style.display = 'none';
                } else if (percentage < 80) {
                    storageElement.className = 'number text-warning';
                    warningElement.className = 'alert alert-warning alert-dismissible fade show no-print';
                    warningElement.style.display = 'block';
                    warningText.textContent = 'Storage Anda sudah mencapai ' + percentage + '%. Pertimbangkan untuk export dan hapus beberapa lembar.';
                } else {
                    storageElement.className = 'number text-danger';
                    warningElement.className = 'alert alert-danger alert-dismissible fade show no-print';
                    warningElement.style.display = 'block';
                    warningText.textContent = 'Storage Anda hampir penuh (' + percentage + '%)! Segera export dan hapus lembar untuk menghindari error.';
                }
                
                return percentage;
            } catch (e) {
                console.error('Error checking storage:', e);
                return 0;
            }
        }

        function updateConfigInfo() {
            const cols = document.getElementById('columnsCount').value;
            const rows = document.getElementById('rowsCount').value;
            const total = cols * rows;
            document.getElementById('configInfo').innerHTML = 
                `${cols} gambar ke samping Ã— ${rows} gambar ke bawah = <strong>${total} gambar per halaman</strong>`;
        }

        function updatePagesEstimate() {
            if (currentImages.length === 0) return;
            
            const cols = parseInt(document.getElementById('columnsCount').value);
            const rows = parseInt(document.getElementById('rowsCount').value);
            const imagesPerPage = cols * rows;
            const totalPages = Math.ceil(currentImages.length / imagesPerPage);
            
            document.getElementById('pagesEstimate').innerHTML = 
                `Dengan setting saat ini, ${currentImages.length} gambar akan dibagi menjadi <strong>${totalPages} halaman</strong>`;
        }

        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                if (!file.type.startsWith('image/')) {
                    showToast(`${file.name} bukan file gambar`, 'warning');
                    return false;
                }
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`${file.name} terlalu besar (max 5MB)`, 'warning');
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) return;

            let processed = 0;
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImages.push(e.target.result);
                    processed++;
                    if (processed === validFiles.length) {
                        renderImagePreview();
                        updatePagesEstimate();
                        showToast(`${validFiles.length} gambar berhasil ditambahkan`, 'success');
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function renderImagePreview() {
            const section = document.getElementById('imagePreviewSection');
            const container = document.getElementById('imagePreviewContainer');
            
            if (currentImages.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            document.getElementById('uploadedCount').textContent = currentImages.length;

            container.innerHTML = currentImages.map((img, idx) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="Gambar ${idx + 1}">
                    <button class="btn-remove-preview" onclick="removeImage(${idx})">Ã—</button>
                    <div class="preview-number">${idx + 1}</div>
                </div>
            `).join('');
        }

        function removeImage(index) {
            currentImages.splice(index, 1);
            renderImagePreview();
            updatePagesEstimate();
            showToast('Gambar dihapus', 'info');
        }

        function saveSheet() {
            if (currentImages.length === 0) {
                showToast('Silakan upload minimal 1 gambar', 'warning');
                return;
            }

            // Check storage before saving
            const storageUsage = checkStorageUsage();
            if (storageUsage > 90) {
                if (!confirm('Storage hampir penuh! Yakin ingin menyimpan? Disarankan untuk export dan hapus lembar lama terlebih dahulu.')) {
                    return;
                }
            }

            const sheet = {
                id: Date.now(),
                title: document.getElementById('pageTitle').value,
                date: document.getElementById('pageDate').value,
                responsible: document.getElementById('responsible').value,
                department: document.getElementById('department').value,
                location: document.getElementById('location').value,
                category: document.getElementById('category').value,
                notes: document.getElementById('notes').value,
                columns: parseInt(document.getElementById('columnsCount').value),
                rows: parseInt(document.getElementById('rowsCount').value),
                images: [...currentImages],
                createdAt: new Date().toISOString()
            };

            sheets.push(sheet);
            saveToStorage();
            renderSheetsList();
            renderPreview();
            resetForm();
            updateStats();
            
            const imagesPerPage = sheet.columns * sheet.rows;
            const totalPages = Math.ceil(sheet.images.length / imagesPerPage);
            showToast(`âœ… Lembar berhasil disimpan! ${sheet.images.length} gambar dibagi menjadi ${totalPages} halaman`, 'success');
            
            // Reminder to export
            if (sheets.length >= 3) {
                setTimeout(() => {
                    showToast('ðŸ’¡ Tips: Anda sudah punya ' + sheets.length + ' lembar. Pertimbangkan untuk export dan hapus agar laptop tetap ringan!', 'info');
                }, 2000);
            }
        }

        function resetForm() {
            document.getElementById('sheetForm').reset();
            currentImages = [];
            renderImagePreview();
            setDefaultDate();
        }

        function saveToStorage() {
            localStorage.setItem('pdamSheets', JSON.stringify(sheets));
        }

        function loadSheets() {
            const saved = localStorage.getItem('pdamSheets');
            if (saved) {
                sheets = JSON.parse(saved);
                renderSheetsList();
                renderPreview();
            }
        }

        function renderSheetsList() {
            const container = document.getElementById('savedSheetsList');
            if (sheets.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Belum ada lembar tersimpan. Buat lembar baru untuk memulai.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sheets.map(sheet => {
                const dateFormatted = new Date(sheet.date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const imagesPerPage = sheet.columns * sheet.rows;
                const totalPages = Math.ceil(sheet.images.length / imagesPerPage);
                
                return `
                    <div class="sheet-item" onclick="scrollToSheet(${sheet.id})">
                        <div class="sheet-item-header">
                            <div>
                                <div class="sheet-item-title">${sheet.title}</div>
                                <div class="sheet-item-meta">
                                    <i class="fas fa-calendar me-2"></i>${dateFormatted}
                                </div>
                            </div>
                            <div>
                                <span class="badge bg-primary me-2">${sheet.images.length} Gambar</span>
                                <span class="badge bg-success">${totalPages} Halaman</span>
                            </div>
                        </div>
                        <div class="sheet-item-meta mt-2">
                            <i class="fas fa-user me-2"></i><strong>PJ:</strong> ${sheet.responsible}
                            ${sheet.department ? `<br><i class="fas fa-building me-2"></i><strong>Dept:</strong> ${sheet.department}` : ''}
                            ${sheet.category ? `<br><i class="fas fa-tag me-2"></i><strong>Kategori:</strong> ${sheet.category}` : ''}
                        </div>
                        <div class="sheet-item-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-outline-primary" onclick="scrollToSheet(${sheet.id})">
                                <i class="fas fa-eye me-1"></i>Lihat
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportSingleSheet(${sheet.id})">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSheet(${sheet.id})">
                                <i class="fas fa-trash me-1"></i>Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('sheetsCount').textContent = sheets.length;
        }

        function renderPreview() {
            const container = document.getElementById('previewArea');
            if (sheets.length === 0) {
                container.innerHTML = '';
                document.getElementById('actionButtons').style.display = 'none';
                return;
            }

            document.getElementById('actionButtons').style.display = 'flex';

            let html = '';
            sheets.forEach(sheet => {
                const imagesPerPage = sheet.columns * sheet.rows;
                const totalPages = Math.ceil(sheet.images.length / imagesPerPage);

                // Loop untuk setiap halaman
                for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                    const startIdx = pageNum * imagesPerPage;
                    const endIdx = Math.min(startIdx + imagesPerPage, sheet.images.length);
                    const pageImages = sheet.images.slice(startIdx, endIdx);

                    const dateFormatted = new Date(sheet.date).toLocaleDateString('id-ID', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    html += `
                        <div class="page-container" id="sheet-${sheet.id}-page-${pageNum}">
                            <div class="page-header">
                                <h3>${sheet.title}</h3>
                                ${totalPages > 1 ? `<div class="page-indicator">Halaman ${pageNum + 1} dari ${totalPages}</div>` : ''}
                                <div class="page-info">
                                    <div class="page-info-row">
                                        <span class="page-info-label"><i class="fas fa-calendar me-2"></i>Hari/Tanggal:</span>
                                        <span class="page-info-value">${dateFormatted}</span>
                                    </div>
                                    <div class="page-info-row">
                                        <span class="page-info-label"><i class="fas fa-user me-2"></i>Penanggung Jawab:</span>
                                        <span class="page-info-value">${sheet.responsible}</span>
                                    </div>
                                    ${sheet.department ? `
                                    <div class="page-info-row">
                                        <span class="page-info-label"><i class="fas fa-building me-2"></i>Departemen:</span>
                                        <span class="page-info-value">${sheet.department}</span>
                                    </div>
                                    ` : ''}
                                    ${sheet.location ? `
                                    <div class="page-info-row">
                                        <span class="page-info-label"><i class="fas fa-map-marker-alt me-2"></i>Lokasi:</span>
                                        <span class="page-info-value">${sheet.location}</span>
                                    </div>
                                    ` : ''}
                                    ${sheet.category ? `
                                    <div class="page-info-row">
                                        <span class="page-info-label"><i class="fas fa-tag me-2"></i>Kategori:</span>
                                        <span class="page-info-value">${sheet.category}</span>
                                    </div>
                                    ` : ''}
                                    ${sheet.notes ? `
                                    <div class="page-info-row">
                                        <span class="page-info-label"><i class="fas fa-sticky-note me-2"></i>Keterangan:</span>
                                        <span class="page-info-value">${sheet.notes}</span>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="image-container" style="grid-template-columns: repeat(${sheet.columns}, 1fr);">
                                ${pageImages.map((img, idx) => {
                                    const globalIdx = startIdx + idx + 1;
                                    return `
                                        <div class="image-item">
                                            <img src="${img}" alt="Gambar ${globalIdx}">
                                            <div class="image-counter">Gambar ${globalIdx}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${pageNum === totalPages - 1 ? `
                                <div class="text-center mt-3 text-muted">
                                    <small>Total ${sheet.images.length} gambar dalam ${totalPages} halaman</small>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        function scrollToSheet(id) {
            const element = document.getElementById(`sheet-${id}-page-0`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                element.style.animation = 'pulse 1s';
                setTimeout(() => {
                    element.style.animation = '';
                }, 1000);
            }
        }

        function deleteSheet(id) {
            if (confirm('Yakin ingin menghapus lembar ini?')) {
                sheets = sheets.filter(s => s.id !== id);
                saveToStorage();
                renderSheetsList();
                renderPreview();
                updateStats();
                showToast('Lembar berhasil dihapus', 'warning');
            }
        }

        function filterSheets(query) {
            const filtered = sheets.filter(sheet => {
                const searchText = `${sheet.title} ${sheet.date} ${sheet.responsible} ${sheet.department || ''} ${sheet.category || ''}`.toLowerCase();
                return searchText.includes(query.toLowerCase());
            });

            const container = document.getElementById('savedSheetsList');
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <p>Tidak ada hasil untuk pencarian "${query}"</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(sheet => {
                const dateFormatted = new Date(sheet.date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const imagesPerPage = sheet.columns * sheet.rows;
                const totalPages = Math.ceil(sheet.images.length / imagesPerPage);
                
                return `
                    <div class="sheet-item" onclick="scrollToSheet(${sheet.id})">
                        <div class="sheet-item-header">
                            <div>
                                <div class="sheet-item-title">${sheet.title}</div>
                                <div class="sheet-item-meta">
                                    <i class="fas fa-calendar me-2"></i>${dateFormatted}
                                </div>
                            </div>
                            <div>
                                <span class="badge bg-primary me-2">${sheet.images.length} Gambar</span>
                                <span class="badge bg-success">${totalPages} Halaman</span>
                            </div>
                        </div>
                        <div class="sheet-item-meta mt-2">
                            <i class="fas fa-user me-2"></i><strong>PJ:</strong> ${sheet.responsible}
                            ${sheet.department ? `<br><i class="fas fa-building me-2"></i><strong>Dept:</strong> ${sheet.department}` : ''}
                            ${sheet.category ? `<br><i class="fas fa-tag me-2"></i><strong>Kategori:</strong> ${sheet.category}` : ''}
                        </div>
                        <div class="sheet-item-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-outline-primary" onclick="scrollToSheet(${sheet.id})">
                                <i class="fas fa-eye me-1"></i>Lihat
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSheet(${sheet.id})">
                                <i class="fas fa-trash me-1"></i>Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const totalImages = sheets.reduce((sum, sheet) => sum + sheet.images.length, 0);
            const totalPages = sheets.reduce((sum, sheet) => {
                const imagesPerPage = sheet.columns * sheet.rows;
                return sum + Math.ceil(sheet.images.length / imagesPerPage);
            }, 0);

            document.getElementById('totalSheets').textContent = sheets.length;
            document.getElementById('totalImages').textContent = totalImages;
            document.getElementById('totalPages').textContent = totalPages;
            
            checkStorageUsage();
        }

        function printPages() {
            window.print();
        }

        async function exportSingleSheet(id) {
            const sheet = sheets.find(s => s.id === id);
            if (!sheet) return;

            showToast('Sedang memproses export...', 'info');

            try {
                const zip = new JSZip();
                const sheetFolderName = sanitizeFilename(sheet.title);
                const sheetFolder = zip.folder(sheetFolderName);
                
                const imagesPerPage = sheet.columns * sheet.rows;
                const totalPages = Math.ceil(sheet.images.length / imagesPerPage);
                
                // Save metadata
                const metadata = {
                    title: sheet.title,
                    date: sheet.date,
                    responsible: sheet.responsible,
                    department: sheet.department,
                    location: sheet.location,
                    category: sheet.category,
                    notes: sheet.notes,
                    totalImages: sheet.images.length,
                    imagesPerPage: imagesPerPage,
                    totalPages: totalPages,
                    layout: `${sheet.columns}x${sheet.rows}`
                };
                sheetFolder.file('info.json', JSON.stringify(metadata, null, 2));

                // Save images in Images folder
                const imagesFolder = sheetFolder.folder('Images');
                sheet.images.forEach((img, imgIdx) => {
                    const base64Data = img.split(',')[1];
                    const pageNum = Math.floor(imgIdx / imagesPerPage) + 1;
                    const positionInPage = (imgIdx % imagesPerPage) + 1;
                    imagesFolder.file(`hal${pageNum}_pos${positionInPage}_gambar${imgIdx + 1}.jpg`, base64Data, {base64: true});
                });

                // Generate PDF
                showToast('Membuat PDF...', 'info');
                const pdfBlob = await generatePDFForSheet(sheet, 0);
                sheetFolder.file(`${sanitizeFilename(sheet.title)}.pdf`, pdfBlob);

                // Generate ZIP
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                });
                
                // Download
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sanitizeFilename(sheet.title)}_${new Date().toISOString().split('T')[0]}.zip`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Export berhasil!', 'success');
                
                // Ask if want to delete
                setTimeout(() => {
                    if (confirm('Export berhasil! Hapus lembar ini untuk mengosongkan storage?')) {
                        deleteSheet(id);
                    }
                }, 1000);

            } catch (error) {
                console.error('Export error:', error);
                showToast('Terjadi kesalahan saat export', 'danger');
            }
        }

        async function exportZip() {
            if (sheets.length === 0) {
                showToast('Tidak ada lembar untuk diekspor', 'warning');
                return;
            }

            showToast('Sedang memproses export... Mohon tunggu', 'info');

            try {
                const zip = new JSZip();
                const folder = zip.folder('PDAM_Lembar_Gambar');

                // Process each sheet
                for (let sheetIdx = 0; sheetIdx < sheets.length; sheetIdx++) {
                    const sheet = sheets[sheetIdx];
                    const sheetFolderName = `${sheetIdx + 1}_${sanitizeFilename(sheet.title)}`;
                    const sheetFolder = folder.folder(sheetFolderName);
                    
                    const imagesPerPage = sheet.columns * sheet.rows;
                    const totalPages = Math.ceil(sheet.images.length / imagesPerPage);
                    
                    // Save metadata
                    const metadata = {
                        title: sheet.title,
                        date: sheet.date,
                        responsible: sheet.responsible,
                        department: sheet.department,
                        location: sheet.location,
                        category: sheet.category,
                        notes: sheet.notes,
                        totalImages: sheet.images.length,
                        imagesPerPage: imagesPerPage,
                        totalPages: totalPages,
                        layout: `${sheet.columns}x${sheet.rows}`
                    };
                    sheetFolder.file('info.json', JSON.stringify(metadata, null, 2));

                    // Save images in Images folder
                    const imagesFolder = sheetFolder.folder('Images');
                    sheet.images.forEach((img, imgIdx) => {
                        const base64Data = img.split(',')[1];
                        const pageNum = Math.floor(imgIdx / imagesPerPage) + 1;
                        const positionInPage = (imgIdx % imagesPerPage) + 1;
                        imagesFolder.file(`hal${pageNum}_pos${positionInPage}_gambar${imgIdx + 1}.jpg`, base64Data, {base64: true});
                    });

                    // Generate PDF for this sheet
                    showToast(`Membuat PDF untuk "${sheet.title}"...`, 'info');
                    const pdfBlob = await generatePDFForSheet(sheet, sheetIdx);
                    sheetFolder.file(`${sanitizeFilename(sheet.title)}.pdf`, pdfBlob);
                }

                // Generate the ZIP file
                showToast('Mengkompresi file...', 'info');
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                });
                
                // Download the ZIP
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PDAM_Lembar_Gambar_${new Date().toISOString().split('T')[0]}.zip`;
                a.click();
                URL.revokeObjectURL(url);

                // Show modal to ask if want to clear
                exportModal.show();

            } catch (error) {
                console.error('Export error:', error);
                showToast('Terjadi kesalahan saat export. Silakan coba lagi.', 'danger');
            }
        }

        async function generatePDFForSheet(sheet, sheetIdx) {
            // Create a temporary container for PDF generation
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            document.body.appendChild(tempContainer);

            const imagesPerPage = sheet.columns * sheet.rows;
            const totalPages = Math.ceil(sheet.images.length / imagesPerPage);

            // Build HTML for all pages
            let pdfHTML = '';
            for (let pageNum = 0; pageNum < totalPages; pageNum++) {
                const startIdx = pageNum * imagesPerPage;
                const endIdx = Math.min(startIdx + imagesPerPage, sheet.images.length);
                const pageImages = sheet.images.slice(startIdx, endIdx);

                const dateFormatted = new Date(sheet.date).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                pdfHTML += `
                    <div style="padding: 20px; page-break-after: always; font-family: Arial, sans-serif;">
                        <div style="text-align: center; border-bottom: 3px solid #007bff; padding-bottom: 15px; margin-bottom: 20px;">
                            <h2 style="color: #007bff; margin: 0 0 10px 0;">${sheet.title}</h2>
                            ${totalPages > 1 ? `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 15px; border-radius: 20px; display: inline-block; margin-bottom: 10px;">Halaman ${pageNum + 1} dari ${totalPages}</div>` : ''}
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                            <table style="width: 100%; font-size: 14px;">
                                <tr>
                                    <td style="padding: 5px;"><strong>ðŸ“… Hari/Tanggal:</strong></td>
                                    <td style="padding: 5px;">${dateFormatted}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 5px;"><strong>ðŸ‘¤ Penanggung Jawab:</strong></td>
                                    <td style="padding: 5px;">${sheet.responsible}</td>
                                </tr>
                                ${sheet.department ? `
                                <tr>
                                    <td style="padding: 5px;"><strong>ðŸ¢ Departemen:</strong></td>
                                    <td style="padding: 5px;">${sheet.department}</td>
                                </tr>
                                ` : ''}
                                ${sheet.location ? `
                                <tr>
                                    <td style="padding: 5px;"><strong>ðŸ“ Lokasi:</strong></td>
                                    <td style="padding: 5px;">${sheet.location}</td>
                                </tr>
                                ` : ''}
                                ${sheet.category ? `
                                <tr>
                                    <td style="padding: 5px;"><strong>ðŸ·ï¸ Kategori:</strong></td>
                                    <td style="padding: 5px;">${sheet.category}</td>
                                </tr>
                                ` : ''}
                                ${sheet.notes ? `
                                <tr>
                                    <td style="padding: 5px;"><strong>ðŸ“ Keterangan:</strong></td>
                                    <td style="padding: 5px;">${sheet.notes}</td>
                                </tr>
                                ` : ''}
                            </table>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(${sheet.columns}, 1fr); gap: 10px;">
                            ${pageImages.map((img, idx) => {
                                const globalIdx = startIdx + idx + 1;
                                return `
                                    <div style="border: 2px solid #e1e5ee; border-radius: 8px; overflow: hidden; position: relative; min-height: 150px; display: flex; align-items: center; justify-content: center; background: white;">
                                        <img src="${img}" style="max-width: 100%; max-height: 100%; display: block;">
                                        <div style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                            Gambar ${globalIdx}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${pageNum === totalPages - 1 ? `
                            <div style="text-align: center; margin-top: 15px; color: #6c757d; font-size: 12px;">
                                Total ${sheet.images.length} gambar dalam ${totalPages} halaman
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            tempContainer.innerHTML = pdfHTML;

            // Generate PDF
            const opt = {
                margin: 10,
                filename: `${sanitizeFilename(sheet.title)}.pdf`,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            const pdfBlob = await html2pdf().set(opt).from(tempContainer).outputPdf('blob');
            
            // Clean up
            document.body.removeChild(tempContainer);
            
            return pdfBlob;
        }

        function sanitizeFilename(filename) {
            return filename.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        }

        function clearAll(skipConfirm = false) {
            if (!skipConfirm) {
                if (!confirm('PERHATIAN: Ini akan menghapus SEMUA lembar yang tersimpan. Yakin ingin melanjutkan?')) {
                    return;
                }
                if (!confirm('Konfirmasi sekali lagi. Data yang dihapus tidak dapat dikembalikan!')) {
                    return;
                }
            }
            
            sheets = [];
            saveToStorage();
            renderSheetsList();
            renderPreview();
            updateStats();
            showToast('âœ… Semua lembar berhasil dihapus. Storage laptop Anda sudah dikosongkan!', 'success');
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.createElement('div');
            toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
            
            const colors = {
                success: '#28a745',
                warning: '#ffc107',
                danger: '#dc3545',
                info: '#17a2b8'
            };

            const icons = {
                success: 'fa-check-circle',
                warning: 'fa-exclamation-triangle',
                danger: 'fa-times-circle',
                info: 'fa-info-circle'
            };

            toastContainer.innerHTML = `
                <div class="toast show" role="alert" style="min-width: 300px; background-color: ${colors[type]}; color: white; border-radius: 8px;">
                    <div class="toast-body d-flex align-items-center p-3">
                        <i class="fas ${icons[type]} me-2 fa-lg"></i>
                        <span>${message}</span>
                    </div>
                </div>
            `;

            document.body.appendChild(toastContainer);

            setTimeout(() => {
                toastContainer.remove();
            }, 4000);
        }

        // Add pulse animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.02); box-shadow: 0 10px 30px rgba(0, 123, 255, 0.3); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>